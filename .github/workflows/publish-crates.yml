name: Publish to crates.io

on:
  release:
    types: [published]

env:
  CARGO_TERM_COLOR: always

permissions:
  contents: read
  id-token: write  # Required for OIDC trusted publishing

jobs:
  publish:
    name: Publish to crates.io
    runs-on: ubuntu-latest
    # Only run on tags that match v*.*.*
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Set version from release tag
        run: |
          TAG_VERSION=${GITHUB_REF#refs/tags/v}
          sed -i "0,/^version = /s/^version = \"[^\"]*\"/version = \"$TAG_VERSION\"/" Cargo.toml
          echo "Set Cargo.toml version to $TAG_VERSION"
      
      - name: Run tests
        run: cargo test --all-features --workspace
      
      - name: Publish
        run: |
          cargo publish